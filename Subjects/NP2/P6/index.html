<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="None">
        
        <link rel="canonical" href="https://iot-da.github.io/Subjects/NP2/P6/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Internet of Things and Data Analytics</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body class="homepage">

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../..">Internet of Things and Data Analytics</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../../..">Home</a>
                            </li>
                            <li >
                                <a href="../../../General/">General info.</a>
                            </li>
                            <li >
                                <a href="../../../News/">News</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Subjects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../IOTNA/">IOTNA</a>
</li>
                                    
<li >
    <a href="../../MDM/">MDM</a>
</li>
                                    
<li >
    <a href="../../SID/">SID</a>
</li>
                                    
<li >
    <a href="../../IA/">IA</a>
</li>
                                    
<li >
    <a href="../../NP1/">NP1</a>
</li>
                                    
<li >
    <a href="../">NP2</a>
</li>
                                    
<li >
    <a href="../../SEC/">SEC</a>
</li>
                                    
<li >
    <a href="../../EDGE/">EDGE</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../../../Contact/">Contact</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#laboratory-4-mqtt-i-deployment-of-clients-and-serversbrokers-traffic-analysis">Laboratory 4. MQTT (I). Deployment of clients and servers/brokers. Traffic analysis</a></li>
            <li><a href="#objectives">Objectives</a></li>
            <li><a href="#publicationsubscription-on-a-broker-in-the-cloud">Publication/subscription on a broker in the cloud</a></li>
            <li><a href="#deploying-a-local-broker-using-eclipse-mosquitto">Deploying a local broker using Eclipse Mosquitto</a></li>
            <li><a href="#developing-a-local-client-using-eclipse-paho">Developing a local client using Eclipse Paho</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="laboratory-4-mqtt-i-deployment-of-clients-and-serversbrokers-traffic-analysis">Laboratory 4. MQTT (I). Deployment of clients and servers/brokers. Traffic analysis</h1>
<h2 id="objectives">Objectives</h2>
<ul>
<li>
<p>To familiarize with the use of brokers and clients for subscription/publication using MQTT.</p>
</li>
<li>
<p>To deploy a system based on MQTT locally, including broker and clients.</p>
</li>
<li>
<p>To use Eclipse Paho to integrate functionality for MQTT in Python programs.</p>
</li>
<li>
<p>To familiarize with the use of MQTT wildcards.</p>
</li>
</ul>
<h2 id="publicationsubscription-on-a-broker-in-the-cloud">Publication/subscription on a broker in the cloud</h2>
<p>In this first part, we will use a server/broker available in the cloud for its use
from users (<em>test.mosquitto.org</em>). 
This server is usually employed for testing and debugging, and you need to realize that
all the information published on it can be read by any subscriptor. Take this into account
when publishing important information via MQTT.</p>
<p>The server listens on the following ports:</p>
<ul>
<li><strong>1883</strong>: MQTT, no encryption.</li>
<li><strong>8883</strong>: MQTT, with encryption.</li>
<li><strong>8884</strong>: MQTT, with encryption, user certificate required.</li>
<li><strong>8080</strong>: MQTT over WebSockets, without encryption.</li>
<li><strong>8081</strong>: MQTT over WebSockets, with encryption.</li>
</ul>
<p>In order to perform publications/subscriptions on the broker, we will use
the <a href="https://mosquitto.org"><em>mosquitto</em></a> distribution from the Eclipse IoT projecto.
Even thourgh <em>mosquitto</em> is mainly an implementation of an MQTT broker, we will use it in this
step as a client; this will allow us to subscribe or publish on any MQTT topic.</p>
<p>First, install <em>mosquitto</em>:</p>
<pre><code class="sh">sudo apt-get install mosquitto mosquitto-clients mosquitto-dev libmosquitto*
</code></pre>

<p>Provided there were no errors, you will find two binaries ready for execution:</p>
<ul>
<li><code>mosquitto_sub</code>: to subscribe to a given topic via a broker.</li>
<li><code>mosquitto_pub</code>: to publish a message associated to a given topic via a  broker.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Task</p>
<p>Observe the help of both commands, using the argument <code>--help</code>. Identify<br />
the parameters that allow specifying the destination broker, the topic to use and, when publishing
the message to send.</p>
</div>
<p>Let us subscribe to the topic <code>#</code> in the broker, using the order:</p>
<pre><code class="sh">mosquitto_sub -h test.mosquitto.org  -t &quot;#&quot;
</code></pre>

<div class="admonition note">
<p class="admonition-title">Task</p>
<p>Pause the output (Ctrl+C) as soon as you can. What are the messages you are observing?</p>
</div>
<p>Next, we will complete a process of publication/subscription with a known topic (e.g. 
<code>/MIOT/yourname/</code>). In order to publish a message under this topic:</p>
<pre><code class="sh">mosquitto_pub -h test.mosquitto.org -t &quot;/MIOT/tunombre&quot; -m &quot;Hola, soy tunombre&quot;
</code></pre>

<div class="admonition note">
<p class="admonition-title">Task</p>
<p>Subscribe to the topic <code>/MIOT/yourname</code> and observe if you can receive the results
after the corresponding publication. How could you subscribe to all messages published
by your classmates?</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Task</p>
<p>Perform an analysis of the message excghanges necessary for a process of 
publication/subscription on the test broker. Study the type of protocol
of the transport layer that is used by MQTT, data and control messages, protocol
overhead and, in general, any aspect that you consider of interest.</p>
</div>
<h2 id="deploying-a-local-broker-using-eclipse-mosquitto">Deploying a local broker using Eclipse Mosquitto</h2>
<p>The use of a remote server presents advantages (ease of use), but a series of 
inconvenients (security, lack of configuration mechanisms, ...).</p>
<p>In this section, we will configure a <em>mosquitto</em> borker to deploy a local
MQTT infrastructure under our control.</p>
<p>Booting a broker (server) in mosquitto is performed via the command <code>mosquitto</code>:</p>
<pre><code class="sh">mosquitto [-c config file] [ -d | --daemon ] [-p port number] [-v]
</code></pre>

<p>However, in many Linux distributions, the broker boots by default on system boot, 
and it is executed continously in background. In order to check the status of 
the broker, you can execute:</p>
<pre><code class="sh">sudo service mosquitto status
</code></pre>

<p>You will observe a message that indicates that the service is active. The options
<code>restart</code>, <code>start</code> or <code>stop</code> will allow you to control the status of the broker.</p>
<div class="admonition note">
<p class="admonition-title">Task</p>
<p>Check that, with the broker online, you can perform a subscription/publication
process on it.</p>
</div>
<p>The mosquitto broker allows a monitorization of statistics and information of its
status using the MQTT protocol. Hence, the topics <code>$SYS</code> return, periodically
or when an event occurs, the information of the status of the broker. You can
query more details in the manual page of <em>mosquitto</em>
(command <code>man mosquitto</code>), under the section <em>BROKER STATUS</em>.</p>
<div class="admonition note">
<p class="admonition-title">Task</p>
<p>Query the status of the broker while you perform subscription/publication processes,
reporting received/sent bytes, number of active/inactive connections, and number of 
sent/received bytes by the broker.</p>
</div>
<h2 id="developing-a-local-client-using-eclipse-paho">Developing a local client using Eclipse Paho</h2>
<p>The clients <code>mosquitto_pub</code> and <code>mosquitto_sub</code> are bsically tools for development and
testing, but it is interesting to know libraries that allow the integration
of MQTT into existing programs. One of them is <a href="https://www.eclipse.org/paho">Eclipse Paho</a>. 
Paho is an infrastructure devleloped by the Eclipse IoT project to support implementations
of protocols of instant messaging (M2M and IoT), even though as of today, it is exclusively
focused on MQTT.</p>
<p>In our case, we will use the Python version of the library, that can be installed via:</p>
<pre><code class="sh">pip install paho-mqtt
</code></pre>

<p>All documentation for the module is available via <a href="https://pypi.org/project/paho-mqtt/#usage-and-api">this link</a>.</p>
<p>The deployment of simple example for a client that connects to a broker and subscribes to the
<code>$SYS</code> topic, printing all received messages, would result, using Paho from Python, in:</p>
<pre><code class="python">import paho.mqtt.client as mqtt

# Callback function invoked qhen the client receives a CONNACK from the broker.
def on_connect(client, userdata, flags, rc):
    print(&quot;Connected with result code &quot;+str(rc))

    # Subscribin in on_connect() makes sure that if connection is lost and restablished,
    # the subscription will be renewed
    client.subscribe(&quot;$SYS/#&quot;)

# Callback function upon publication message reception (PUBLISH) from the broker.
def on_message(client, userdata, msg):
    print(msg.topic+&quot; &quot;+str(msg.payload))

client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message

client.connect(&quot;mqtt.eclipse.org&quot;, 1883, 60)

# Blocking call that processes network traffic, invokes callbacks and handles broker reconnections.
client.loop_forever()
</code></pre>

<p>The client class can be used to:</p>
<ul>
<li>Create an instance of an MQTT client.</li>
<li>Connect to a <em>broker</em> using the functions of the <code>connect*()</code> family.</li>
<li>Invoke functions of the <code>loop*()</code> family to maintain data traffic with the server.</li>
<li>Use <code>subscribe()</code> to subscribe to a topic or receiving messages.</li>
<li>Use <code>publish()</code> to publish messages in the broker.</li>
<li>Use <code>disconnect()</code> to disconnect from the broker.</li>
</ul>
<p>The callbacks will be invoked automatically to allow processing events. Among other, we highlight:</p>
<ul>
<li><code>ON_CONNECT</code>: invoked when the broker responds to our connection request. Example:</li>
</ul>
<pre><code class="python">def on_connect(client, userdata, flags, rc):
    print(&quot;Connection returned result: &quot;+connack_string(rc))
</code></pre>

<ul>
<li><code>ON_DISCONNECT</code>: invoked when the client disconnects from the broker. Example:</li>
</ul>
<pre><code class="python">def on_disconnect(client, userdata, rc):
    if rc != 0:
        print(&quot;Unexpected disconnection.&quot;)
</code></pre>

<ul>
<li><code>ON_MESSAGE</code>: invoked when a message on a topic is received and the client is subscribed:
Example:</li>
</ul>
<pre><code class="python">def on_message(client, userdata, message):
    print(&quot;Received message '&quot; + str(message.payload) + &quot;' on topic '&quot;
        + message.topic + &quot;' with QoS &quot; + str(message.qos))
</code></pre>

<p>In order to publish on a punctual manner on a broker (without keeping a connection
open), it is possible to use the following sequence of orders:</p>
<pre><code class="python">import paho.mqtt.publish as publish

publish.single(&quot;paho/test/single&quot;, &quot;payload&quot;, hostname=&quot;mqtt.eclipse.org&quot;)
</code></pre>

<p>Similarly, we can subscribe only to a topic with a blocking call as:</p>
<pre><code class="python">import paho.mqtt.subscribe as subscribe

msg = subscribe.simple(&quot;paho/test/simple&quot;, hostname=&quot;mqtt.eclipse.org&quot;)
print(&quot;%s %s&quot; % (msg.topic, msg.payload))
</code></pre>

<p>All the information and documentation for the module can be found <a href="https://pypi.org/project/paho-mqtt/">here</a>.</p>
<h3 id="wildcards">Wildcards</h3>
<p>In addition of using complete topics for the subscription process, topics can include wildcards
in their structure. 
<code>+</code> is the wildcard used to obtain correspondences with a unique level of the hierarchy. Hence
for a topic <code>a/b/c/d</code>, the following subscriptions would match:</p>
<ul>
<li><code>a/b/c/d</code></li>
<li><code>+/b/c/d</code></li>
<li><code>a/+/c/d</code></li>
<li><code>a/+/+/d</code></li>
<li><code>+/+/+/+</code></li>
</ul>
<p>But not the following:</p>
<ul>
<li><code>a/b/c</code></li>
<li><code>b/+/c/d</code></li>
<li><code>+/+/+</code></li>
</ul>
<p>The second wildcard supported is <code>#</code>, and permits matchings on any successive level of the 
hierarchy. Hence for a topic <code>a/b/c/d</code>, the following subscriptions would match:</p>
<ul>
<li><code>a/b/c/d</code></li>
<li><code>#</code></li>
<li><code>a/#</code></li>
<li><code>a/b/#</code></li>
<li><code>a/b/c/#</code></li>
<li><code>+/b/c/#</code></li>
</ul>
<div class="admonition danger">
<p class="admonition-title">Task</p>
<p>Each student will propose a solution to monitor traffic on an intelligent building
via MQTT. For that, the building will be composed by:</p>
<ul>
<li>An identifier: <code>BUILDING_NAME</code>.</li>
<li>A set of floors, identified by the string <code>P_NUMFLOOR</code>.</li>
<li>For each plant, four wings (north -N-, south -S-, east -E-, west -O-)</li>
<li>At each wing, a set of rooms, identified by a numeric value.</li>
<li>For each room, four sensors: TEMP (temperature), HUM (humidity), LUX (luminosity), VIBR (vibration).</li>
</ul>
<p>First, design the hierarcy of topics that allows a correct monitorization of the buildings.</p>
<p>Second, you will develop a Python client that publishes, periodically and in a random manner,
JSON objects (optionally, you can use CBOR) that include values for temperature, humidity, luminosity
or vibration for a specific room of the building, also chosen randomly, via a topic. These messages
will be  separated in time a random number of seconds.</p>
<p>Third, define the wildcards that allow querying for different types of information in a hierarchical
fashion. For example:</p>
<ul>
<li>All messages of temperature for the building.</li>
<li>All messages of vibration for the west wing of the second floor of the building.</li>
<li>All sensorization messages for the room number 4 of the south wing of floor 7 in the building.</li>
<li>...</li>
</ul>
<p>Last, develop a Python program that acts as an alarm, and that shows on screen messages only if a 
received value is above a pre-established threshold. In that case, the program will show
the building, floor, wing, room and sensor that produced the alarm, together with its numeric value.</p>
<p>You can use the  <a href="https://docs.python.org/3/library/json.html">JSON module</a>
to parse the receive objects.</p>
</div></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!--
MkDocs version : 1.0.4
Build Date UTC : 2022-03-22 07:10:17
-->
