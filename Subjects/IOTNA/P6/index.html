<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="None">
        
        <link rel="canonical" href="https://iot-da.github.io/Subjects/IOTNA/P6/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Internet of Things and Data Analytics</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body class="homepage">

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../..">Internet of Things and Data Analytics</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../../..">Home</a>
                            </li>
                            <li >
                                <a href="../../../General/">General info.</a>
                            </li>
                            <li >
                                <a href="../../../News/">News</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Subjects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../">IOTNA</a>
</li>
                                    
<li >
    <a href="../../MDM/">MDM</a>
</li>
                                    
<li >
    <a href="../../SID/">SID</a>
</li>
                                    
<li >
    <a href="../../IA/">IA</a>
</li>
                                    
<li >
    <a href="../../NP1/">NP1</a>
</li>
                                    
<li >
    <a href="../../NP2/">NP2</a>
</li>
                                    
<li >
    <a href="../../SEC/">SEC</a>
</li>
                                    
<li >
    <a href="../../EDGE/">EDGE</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../../../Contact/">Contact</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#lab-6-energy-saving-modes">Lab 6. Energy saving modes</a></li>
            <li><a href="#goals">Goals</a></li>
            <li><a href="#documentation">Documentation</a></li>
            <li><a href="#explicitly-moving-to-low-power-modes">Explicitly moving to low power modes</a></li>
            <li><a href="#using-the-power-manager">Using the Power Manager</a></li>
            <li><a href="#using-high-resolution-timers-optional">Using High Resolution Timers (OPTIONAL)</a></li>
            <li><a href="#delivering-the-assignment">Delivering the assignment</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="lab-6-energy-saving-modes">Lab 6. Energy saving modes</h1>
<h2 id="goals">Goals</h2>
<p>Learn the mechanisms provided by ESP-IDF to exploit the different energy modes existing in ESP32 SoCs:</p>
<ul>
<li>Explicit moving into <em>light sleep</em> and <em>deep sleep</em> modes</li>
<li>Discover wakeup reasons.</li>
<li>Configuring and using the automatic power manager in ESP-IDF.</li>
</ul>
<h2 id="documentation">Documentation</h2>
<p>To complete this assignment, you may need to check the slides discuss in the lectures and the official API documentation:</p>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/sleep_modes.html">Sleep modes</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/power_management.html">Power manager</a></li>
</ul>
<p>It is also relevant to check the examples provided in GitHub:</p>
<ul>
<li><a href="https://github.com/espressif/esp-idf/tree/master/examples/system/light_sleep">Light sleep</a></li>
<li><a href="https://github.com/espressif/esp-idf/tree/master/examples/system/deep_sleep">Deep sleep</a></li>
<li><a href="https://github.com/espressif/esp-idf/tree/master/examples/wifi/power_save">Wifi Power save</a></li>
</ul>
<h2 id="explicitly-moving-to-low-power-modes">Explicitly moving to low power modes</h2>
<p>We will start from a basic code monitoring any input device (like the button or the temperature sensor), where the main program is in an endless loop reading, periodically, the device status. The structure of the starting code could be similar to:</p>
<pre><code class="c">while (1) {
    med = read_device(); // Could be button, sensor...
    ESP_LOGI(TAG,&quot;Medida: %f&quot;, med);
    vTaskDelay(pdMS_TO_TICKS(DELAY));
}
</code></pre>

<p>Implement the following modifications:</p>
<ul>
<li>Include a explicit call to enter <em>light sleep</em> after 5 iterations. Previously, you will configure the <em>wakeup</em> mechanism to be the <em>timer</em> and instruct it to wake the system up after 10 seconds.</li>
<li>Repeat the previous point but entering <em>deep sleep</em></li>
<li>Include code to determine the cause of the <em>wakeup</em> for both previous cases.</li>
</ul>
<div class="admonition danger">
<p class="admonition-title">Questions</p>
<ul>
<li>What difference do you observe when entering <em>deep sleep</em> compared with <em>light sleep</em>? What does it happen after 10 seconds in each case?</li>
<li>Where do you need to include the code to determine the <em>wakeup</em> cause in each of the two cases?</li>
</ul>
</div>
<h2 id="using-the-power-manager">Using the Power Manager</h2>
<p>Starting from the same simple code of previous section, we will be using the <em>Power Manager</em> provided by ESP-IDF. </p>
<p>In order to do so, we must enable <em>Dynamic frequency scaling</em> (DFS). We can enable it with <em>menuconfig</em> -&gt; <em>Component config -&gt; Power Management -&gt; Support for Power Management -&gt; Enable DFS at startup</em>.  It is also possible to configure it in our own code using the call <code>esp_pm_configure()</code>. </p>
<p>You will use this latter method (<code>esp_pm_configure()</code>) and define:
* Max. frequency of 240MHz
* Min. frequency of 40MHz
* Enable automatic entering <em>light sleep mode</em></p>
<p>To enable automatic entering <em>light sleep mode</em> we must activate the corresponding option in <em>menuconfig</em>:  <em>Component config -&gt; FreeRTOS -&gt; Tickless Idle Support</em> (this option is only visible if the <em>Enable DFS at startup</em> option is also enabled).</p>
<p>Following the earlier pseudo-code, modify your code in order to guess the <em>wakeup</em> cause. The structure of code could be now similar to:</p>
<pre><code class="c">while (1) {
    med = read_device(); // Could be button, sensor...
    ESP_LOGI(TAG,&quot;Medida: %f&quot;, med);
    vTaskDelay(pdMS_TO_TICKS(DELAY));
    cause =  get_wakeup_cause();
}
</code></pre>

<div class="admonition danger">
<p class="admonition-title">Questions</p>
<ul>
<li>Which mechanism is waking the system up when using the <em>Power Manager</em>?</li>
</ul>
</div>
<h2 id="using-high-resolution-timers-optional">Using High Resolution Timers (OPTIONAL)</h2>
<p>Modify your code to monitor the device (sensor, button...) using a <em>High Resolution Timer</em> instead of using the call to <code>vTaskDelay(pdMS_TO_TICKS(DELAY))</code>.  The main task will configure the high resolution timer and then go to sleep for 100 seconds in and endless loop.</p>
<h3 id="entering-light-sleep-mode-manually">Entering light sleep mode manually</h3>
<p>Modify your code to enter <em>light sleep mode</em> (calling  <code>esp_light_sleep_start()</code>)   after 3 executions of the <em>high resolution timer</em> callback. Set the high resolution timer to trigger every 3 seconds, and program the system to wake up after 10 seconds. Include a log message in the callback function which prints the number of times the callback function has been called.</p>
<div class="admonition danger">
<p class="admonition-title">Questions</p>
<ul>
<li>Call  <code>esp_light_sleep_start()</code> outside the callback function of the high resolution timer.  What happens when the system wakes up? Are there log messages lost? Do they happen when they should happen?</li>
<li>No call  <code>esp_light_sleep_start()</code> inside the callback function of the high resolution timer. Do you observe any difference?</li>
</ul>
</div>
<h3 id="automatically-entering-light-sleep-mode">Automatically entering light sleep mode</h3>
<p>Repeat previous experiments using the Power Manager. </p>
<div class="admonition danger">
<p class="admonition-title">Questions</p>
<ul>
<li>Note that, since you do not manually enter the sleep mode, you will not move into <em>light sleep</em> after 3 executions of the high resolution timer. When is the system moving to <em>light sleep</em>?</li>
<li>What happens with the callback log messages? Do they happen when they should happen?</li>
</ul>
</div>
<h2 id="delivering-the-assignment">Delivering the assignment</h2>
<p>Once you finish the complete assignment (at least the first two sections), please send an email to Prof. Jose Ignacio (jigomez@ucm.es) with the codes develop for each section and a text file (text or PDF) with your answers to the questions. Please send only one email per group.</p>
<p><strong>DEADLINE: 12th January 2022</strong></p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!--
MkDocs version : 1.0.4
Build Date UTC : 2022-07-05 13:31:50
-->
