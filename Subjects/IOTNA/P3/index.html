<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="None">
        
        <link rel="canonical" href="https://iot-da.github.io/Subjects/IOTNA/P3/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Internet of Things and Data Analytics</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body class="homepage">

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../..">Internet of Things and Data Analytics</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../../..">Home</a>
                            </li>
                            <li >
                                <a href="../../../General/">General info.</a>
                            </li>
                            <li >
                                <a href="../../../News/">News</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Subjects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../">IOTNA</a>
</li>
                                    
<li >
    <a href="../../MDM/">MDM</a>
</li>
                                    
<li >
    <a href="../../SID/">SID</a>
</li>
                                    
<li >
    <a href="../../IA/">IA</a>
</li>
                                    
<li >
    <a href="../../NP1/">NP1</a>
</li>
                                    
<li >
    <a href="../../NP2/">NP2</a>
</li>
                                    
<li >
    <a href="../../SEC/">SEC</a>
</li>
                                    
<li >
    <a href="../../EDGE/">EDGE</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../../../Contact/">Contact</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#basic-inputoutput-in-esp-idf">Basic Input/output in ESP-IDF</a></li>
            <li><a href="#goals">Goals</a></li>
            <li><a href="#documentation">Documentation</a></li>
            <li><a href="#using-gpio">Using GPIO</a></li>
            <li><a href="#timers">Timers</a></li>
            <li><a href="#chronometer-optional">Chronometer (optional)</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="basic-inputoutput-in-esp-idf">Basic Input/output in ESP-IDF</h1>
<h2 id="goals">Goals</h2>
<ul>
<li>Learn the basics of input/output, using polling and interrupts</li>
<li>Configuring and use GPIO pins as input/output</li>
<li>Program <em>timers</em> to schedule periodic events</li>
</ul>
<h2 id="documentation">Documentation</h2>
<p>To complete this assignment, you may need to check the slides discuss in the lectures and the official API documentation:</p>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/gpio.html">GPIO</a>
*Â <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/esp_timer.html">Timers</a></li>
</ul>
<h2 id="using-gpio">Using GPIO</h2>
<h3 id="checking-connections">Checking connections</h3>
<p>The first step when using external peripherals connected to our SoC (ESP32) is to learn how are they connected. The module exposes a series of pines from the core and the operating system (ESP-IDF) assigns them a number. We need then to find out which pin number correspond to every relevant connection to us.</p>
<p>In this fist step, you must find out the GPIO number for the button and LED.  The information is usually included in the documentation of the SoC and the board: we need to check both, the SoC and the board. In our case, part of the information may be found in the brief <a href="https://docs.espressif.com/projects/espressif-esp-iot-solution/en/latest/hw-reference/ESP32-MeshKit-Sense_guide.html">online documentation</a>.  If you don't find all the information there, try to look it up carefully in the board itself. Sometimes, this information is printed on the PCB...</p>
<h3 id="simple-gpio-polling-button">Simple GPIO polling: button</h3>
<p>The next step will be to set up the button to use it as an input for our system. First, you will need to configure the GPIO pin:</p>
<ul>
<li>Configure the pin as INPUT.</li>
<li>Disable interrupts.</li>
<li>Enable pull-ip mode.</li>
</ul>
<p>Check the slides and documentation to learn how to do this configuration in ESP-IDF. Remember that you need to declare a variable of type <code>gpio_config_t</code>, assign the relevant fields of such variable and finally call <code>gpio_config( )</code>  to complete the configuration.</p>
<p>Once the configuration of the GPIO is done, you can write a simple sampling loop. Write and endless <em>while</em> loop where you poll the status of the button, print a message if the button is pressed and wait for 250ms before polling again. A <strong>pseudo-code</strong> for such loop could be the following:</p>
<pre><code class="c">while (1) {
   int status = gpio_get_level(GPIO_BUTTON_PIN);
   if (status == BUTTON_PRESSED)
      printf(&quot;Button pressed!!\n&quot;);
   delay(250);
}
</code></pre>

<h3 id="gpio-input-and-output-button-led">GPIO input and output: button + LED</h3>
<p>In the next step, you will configure a GPIO pin as an output in order to control the LEDs.  Similar to the button configuration, the first step is to configure the respective pins (there are two LEDs available):</p>
<ul>
<li>Configure the pin(s) as OUTPUT.</li>
<li>Disable interrupts.</li>
<li>Disable pull-up and pull-down modes.</li>
</ul>
<p>Remember to use  a variable of type <code>gpio_config_t</code> and complete the configuration with a call to <code>gpio_config( )</code>.</p>
<p>Once both the three pins (one input, two outputs) are correctly configured, you will develop a very simple program that will switch one of the LEDs (on/off) every time the 
button is pressed. The <em>pseudo-code</em> may be similar to:</p>
<pre><code class="c">while (1) {
   int status = gpio_get_level(GPIO_BUTTON_PIN);
   if (status == BUTTON_PRESSED) {
        if LED_IS_ON 
       gpio_set_level(GPIO_LED_PIN, OFF);
    else
           gpio_set_level(GPIO_LED_PIN, ON);
   }

    delay(250);
}
</code></pre>

<div class="admonition danger">
<p class="admonition-title">Stop and sync </p>
<p>Please send a message in Zoom chat  to the professor as soon as you finished</p>
</div>
<h3 id="gpio-interrupts">GPIO interrupts</h3>
<p>In this subsection you will change the polling mechanism and use interrupts instead. Starting from the configuration you already have for the button GPIO pin, you need to do certain modifications:</p>
<ul>
<li>Enable interrupts (for example, <code>POSEDGE</code>). You may change the edge/level later using <code>gpio_set_intr_type()</code>.</li>
<li>Register the ISR that will be executed when the interrupt rises. You will need to call <code>gpio_install_isr_service()</code> and <code>gpio_isr_handler_add</code>.</li>
</ul>
<p>Once the new configuration is done, you need to write the ISR for the button interrupts. Remember to use the correct protoype: <code>static void IRAM_ATTR gpio_isr_handler(void* arg)</code>(you may change the name of the ISR itself, but not its prototype).</p>
<p>Finally, adapt the previous code (LED switching) to work with the new code. How are you going to notify you main loop about a new interrupt?</p>
<h3 id="extending-button-functionality">Extending button functionality</h3>
<p>Just to play a bit longer with interrupts, let's extend the functionality of our application. Adapt your code so you can identify if the button was pressed <em>normally</em> or if it was hold at least for 4 seconds:</p>
<ul>
<li>If the button was just pressed (less than 4 seconds) you will switch the green LED.</li>
<li>If the button was pressed and hold for more than 4 seconds, you will switch the red LED.</li>
</ul>
<p>Note that, if both LEDs are on, you will see a yellow light.</p>
<div class="admonition danger">
<p class="admonition-title">Stop and sync </p>
<p>Please send a message (using Zoom) to the professor as soon as you finished.</p>
</div>
<h2 id="timers">Timers</h2>
<p>Now we will include timers in our design.  Read again the slides and <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/esp_timer.html">API documentation</a> to remember how to declare and configure a timer in ESP-IDF.</p>
<h3 id="led-blink">LED blink</h3>
<p>Then, create a timer that will blink the red LED every second (i.e. the red LED will be on for one second, then off for another second and so on). The green LED will still be controlled with the button (but keep your code detecting when the button was pressed for more than 4 seconds; you will use it later).</p>
<h3 id="controlling-blinking-frequency">Controlling blinking frequency</h3>
<p>We will define several blinking periods: 500ms,  1s or 2s. When your program starts, the red LED will be blinking every 500ms.  Then, your code must do the following:</p>
<ul>
<li>When the button is pressed, the period will increase, first to 1 second, then to 2 seconds.</li>
<li>If the button is pressed when the period is already 2 seconds, nothing changes.</li>
<li>When the button is held pressed for more than 4 seconds, the period will decrease (from 2s to 1s and then to 500ms).</li>
<li>If the button is held pressed for more than 4 seconds when the period is 500ms, nothing changes.</li>
</ul>
<div class="admonition danger">
<p class="admonition-title">Stop and sync </p>
<p>All previous exercises <strong>must be finished DURING the lecture (not afterwards)</strong> and shown to the teacher during the Zoom meeting. AFTER they are shown to be working during the lecture, the <em>Recorder</em> of the group will send an email with the source code of the last section (<em>Controlling blinking frequency</em>). Remind that plagiarism is strictly prohibited: the code of each group must be solely developed by members of that group.</p>
</div>
<h2 id="chronometer-optional">Chronometer (optional)</h2>
<p>This assignment is optional, but required if you want to obtain more than 6 / 10 in this assignment. You will need to implement a simple chronometer with the following functionality:</p>
<ul>
<li>The chronometer counts minutes and seconds.</li>
<li>Pressing the button starts/stops counting.</li>
<li>Holding pressed the button for more than 4 seconds resets the count to 0.</li>
<li>Every second, the actual count (in a format MM:SS) will be shown in the terminal (using <code>printf()</code>).</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Homework (Optional)</p>
<p>Implement the chronometer using, at least, one <em>timer</em>. Once finished, the <em>Speaker</em> will contact me to <strong>explain (orally) the code developed</strong></p>
</div></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!--
MkDocs version : 1.0.4
Build Date UTC : 2022-01-20 14:45:11
-->
