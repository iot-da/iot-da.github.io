<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="None">
        
        <link rel="canonical" href="https://iot-da.github.io/Subjects/IOTNA/P1/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Internet of Things and Data Analytics</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body class="homepage">

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../..">Internet of Things and Data Analytics</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../../..">Home</a>
                            </li>
                            <li >
                                <a href="../../../General/">General info.</a>
                            </li>
                            <li >
                                <a href="../../../News/">News</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Subjects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../">IOTNA</a>
</li>
                                    
<li >
    <a href="../../MDM/">MDM</a>
</li>
                                    
<li >
    <a href="../../SID/">SID</a>
</li>
                                    
<li >
    <a href="../../IA/">IA</a>
</li>
                                    
<li >
    <a href="../../NP1/">NP1</a>
</li>
                                    
<li >
    <a href="../../NP2/">NP2</a>
</li>
                                    
<li >
    <a href="../../SEC/">SEC</a>
</li>
                                    
<li >
    <a href="../../EDGE/">EDGE</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../../../Contact/">Contact</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#introduction-to-esp-idf-and-platform-io-first-project">Introduction to ESP-IDF and Platform IO. First project</a></li>
            <li><a href="#goals">Goals</a></li>
            <li><a href="#create-a-platformio-project">Create a PlatformIO project</a></li>
            <li><a href="#project-configuration">Project configuration</a></li>
            <li><a href="#including-source-code">Including source code</a></li>
            <li><a href="#flashing-the-project">Flashing the project</a></li>
            <li><a href="#monitoring-the-project">Monitoring the project</a></li>
            <li><a href="#tasks-homework-28102021">Tasks / Homework (28/10/2021)</a></li>
            <li><a href="#extra-optional-memory-map">Extra (OPTIONAL): Memory Map</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="introduction-to-esp-idf-and-platform-io-first-project">Introduction to ESP-IDF and Platform IO. First project</h1>
<h2 id="goals">Goals</h2>
<ul>
<li>Build your first project using PlatformIO</li>
<li>Connect your ESP32 meshkit-sense  board to the computer and upload a simple application</li>
<li>Monitor your application using the serial port</li>
</ul>
<h2 id="create-a-platformio-project">Create a PlatformIO project</h2>
<p>Whenever you want to create a new project, you can add it using the PlatformIO interface.  First, click the <em>PlatformIo Home</em> icon:</p>
<p><img alt="foo" src="img/PlatformIO/1.png" /></p>
<p>From the "PIO Home" tab, select "New Project" and the <em>Project Wizard</em> window will show up:</p>
<p><img alt="foo" src="img/PlatformIO/2.png" /></p>
<p>In that window:</p>
<ul>
<li>Write your  project name (do not use white spaces)</li>
<li>Select <em>Espressif ESP32 Dev Module</em>  as <em>Board</em></li>
<li>Select <em>Espressif IoT Development framework</em> as <em>Framework</em></li>
<li>If you want to choose an <em>ad-hoc</em> location for your project, unselect <em>Use default location</em></li>
<li>Press <em>Finish</em></li>
</ul>
<p>You are done! Your first ESP-IDF project in PlatformIO is already created.</p>
<div class="admonition danger">
<p class="admonition-title">Stop and Sync</p>
<p>If you reach this step, please contact the instructor in the chat to let him/her know. </p>
</div>
<h2 id="project-configuration">Project configuration</h2>
<p>Before proceeding with the application coding, you should configure the project so the framework knows where to find the device and how to communicate with it. There are two main options that we need to specify in the project configuration. Follow the next steps to do it;</p>
<ul>
<li>Double click the file <em>platformio.ini</em> to open it in the editor.</li>
<li>By default it has three options included: <code>platform</code>, <code>board</code>, <code>framework</code>. We are going to include two more below those three:<ul>
<li><code>monitor_speed = 115200</code></li>
<li><code>upload_port = /tty/USB1</code></li>
</ul>
</li>
</ul>
<p>Note that the <code>upload_port</code> specified above is the one used by default in the Virtual Machine provided. If you are not using it, make sure you write the correct port name.</p>
<h2 id="including-source-code">Including source code</h2>
<p>The new project will automatically create a <em>src</em> folder, including a default <em>main.c</em> file with the following content:</p>
<pre><code class="c">void app_main()
{
}
</code></pre>

<p>We are going to write a very simple <em>Hello World</em> application. Write the following code in <em>main.c</em> file:</p>
<pre><code class="c">#include &lt;stdio.h&gt;
#include &quot;freertos/FreeRTOS.h&quot;
#include &quot;freertos/task.h&quot;

void app_main(void)
{

   while (1) {
    printf(&quot;Hello world!\n&quot;);
        vTaskDelay(1000 / portTICK_PERIOD_MS);
  }
  vTaskDelete(NULL);
}
</code></pre>

<p>Once you have written the source code, you can proceed to build the project.  To do so, you can display the  <em>Project Tasks</em> (<code>View-&gt;Command Palette</code>) and execute  <code>PlatformIO: Build</code>. You could also press the <code>Build</code> button (<em>check</em> button in the bottom pane).</p>
<p><img alt="foo" src="img/PlatformIO/3.png" /></p>
<p>If the building process works ok (it may take a few minutes the first time)  you should see a message similar to:</p>
<p><img alt="foo" src="img/PlatformIO/4.png" /></p>
<div class="admonition danger">
<p class="admonition-title">Stop and Sync</p>
<p>If you reach this step, please contact the instructor in the chat to let him/her know. </p>
</div>
<h2 id="flashing-the-project">Flashing the project</h2>
<p>Once we have our application built (note that our source code is linked with the whole ESP-IDF environment, including <em>FreeRTOS</em>), we are ready to upload it to our ESP32 device (this operation is commonly known as <em>flash</em> because we will be writing the binary file in flash memory). </p>
<p>First, plug the ESP32 MeshKit to the ESP-Prog board with the provided connection.  Then, connect the microUSB wire to the corresponding ESP-Prog port and plug the USB end of the wire to your computes USB port. If you are using a virtual machine, you will need to claim the device from the virtual machine, as the host will very likely keep the device by default.</p>
<p>Once you are done physically connecting the devices, you can proceed with the uploading. You can use the  <code>PlatformIO: Upload</code> task from <em>Project Tasks</em> or click in the corresponding button of the bottom pane:</p>
<p><img alt="foo" src="img/PlatformIO/5.png" /></p>
<h2 id="monitoring-the-project">Monitoring the project</h2>
<p>Finally, you can open a serial connection from your computer to the device to monitor the progress.  You can select <code>PlatformIO: Monitor</code> from the <em>Project Tasks</em> or click the <em>plug</em> button in the bottom pane:</p>
<p><img alt="foo" src="img/PlatformIO/6.png" /></p>
<p>Once done, you should see the message *Hello World" in your screen once every second.</p>
<p>Congrats! You have uploaded your first ESP32 project!</p>
<div class="admonition danger">
<p class="admonition-title">Stop and Sync</p>
<p>If you reach this step, please contact the instructor in the chat to let him/her know. </p>
</div>
<h2 id="tasks-homework-28102021">Tasks / Homework (28/10/2021)</h2>
<div class="admonition note">
<p class="admonition-title">Task</p>
<p>Keep a snapshot of your screen at the end of every section (i.e. whenever a <em>Stop and Sync</em> message appears in these instructions) and paste them in a PDF file including the information of your group (names of each of the members of the group). Send the PDF file to the instructor (jigomez@ucm.es) <strong>by the end of this session</strong> (just one file per group).</p>
</div>
<div class="admonition note">
<p class="admonition-title">Homework</p>
<p>Modify the <em>Hello World</em> project so that it prints 10 messages, then it waits for 5 seconds and finally restarts the system. You can find which function you could use for the reset in the <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/system.html">official ESP-IDF documentation</a>. Send the modified source code (only the file <em>main.c</em>) to the instructor before the start of next session (just one file per group).</p>
</div>
<h2 id="extra-optional-memory-map">Extra (OPTIONAL): Memory Map</h2>
<p>Our ESP32 has several memory types (details can be found <a href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/api-guides/memory-types.html">in this link</a> and with more details in the <a href="https://www.espressif.com/sites/default/files/documentation/esp32_technical_reference_manual_en.pdf#sysmem">Technical Reference Manuel (Chapter 1)</a></p>
<p>Most of the code will be placed in the external, flash based memory (SPI flash).  But we can also used some other modules. The most relevant are:</p>
<ul>
<li>
<p><strong>Data RAM</strong>. Global variables (non-constant) are assigned to this SRAM (Static RAM) memory.   Remaining space in this region is used for the runtime heap. This space is mapped to the <em>Internal SRAM 2</em> (200KB) starting at address 0x3FFA_E000 and could also use <em>Internal SRAM 1</em> (128KB) starting at 0x3FFE_0000. Note that SRAM1 could be also used as instruction memory.</p>
</li>
<li>
<p><strong>DROM</strong> (data stored in Flash). By default, constant data is placed by the linker into a region mapped to the MMU flash cache. </p>
</li>
<li>
<p><strong>Instruction RAM</strong> ESP-IDF allocates part of Internal SRAM0 region for instruction RAM. It allows us to use the range 0x4008_0000 to 0x400A_0000 to store parts of the application which need to run from RAM instead of Flash (for example, interrupt handlers are good candidates since they need to run as fast as possible). In order to place code in IRAM we may use the <code>IRAM_ATTR</code> macro:</p>
</li>
</ul>
<pre><code class="c"> #include &quot;esp_attr.h&quot;

void IRAM_ATTR gpio_isr_handler(void* arg)
{
        // ...
}
</code></pre>

<h3 id="heap-memory-allocation">Heap memory allocation</h3>
<p>Since FreeRTOS is mult-threaded, each RTOS task has its own stack. By default, each of these stacks is allocated from the heap when the task is created. </p>
<p>Since there are multiple types of RAM, there are also several heaps with different capabilities. 
Most of the time, you can rely in the standard libc calls (<code>malloc()</code>, <code>free()</code>....). But you may explicitly ask for certain capabilities when allocating memory using <code>heap_caps_malloc()</code>. Please check <a href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/api-reference/system/mem_alloc.html">the documentation in this link for more details</a></p>
<div class="admonition note">
<p class="admonition-title">Homework (Optional)</p>
<p>Create a new project to explore the addresses of different variables. Declare different variables: g lobal variables with initial value, global variables without initial value, global <code>const</code> variables, local variables (stack), allocate memory in the heap using both <code>malloc()</code>and <code>heap_caps_malloc()</code> and try to allocate some function in IRAM. Then print the address of all these symbols (variables, functions...) and check in which memories they are actually allocated.</p>
</div></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!--
MkDocs version : 1.0.4
Build Date UTC : 2022-07-05 13:31:49
-->
