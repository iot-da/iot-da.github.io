<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://iot-da.github.io/Subjects/EDGE/Week7/integrationIoT/">
        <link rel="shortcut icon" href="../../../../img/favicon.ico">
        <title>Integration into a IoT system - Internet of Things and Data Analytics</title>
        <link href="../../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../../..">Internet of Things and Data Analytics</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../../General/" class="nav-link">General info.</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../../News/" class="nav-link">News</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Subjects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../IOTNA/" class="dropdown-item">IOTNA</a>
</li>
                                    
<li>
    <a href="../../../MDM/" class="dropdown-item">MDM</a>
</li>
                                    
<li>
    <a href="../../../SID/" class="dropdown-item">SID</a>
</li>
                                    
<li>
    <a href="../../../IA/" class="dropdown-item">IA</a>
</li>
                                    
<li>
    <a href="../../../NP1/" class="dropdown-item">NP1</a>
</li>
                                    
<li>
    <a href="../../../NP2/" class="dropdown-item">NP2</a>
</li>
                                    
<li>
    <a href="../../../SEC/" class="dropdown-item">SEC</a>
</li>
                                    
<li>
    <a href="../../" class="dropdown-item">EDGE</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../../../Contact/" class="nav-link">Contact</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#integration-into-a-iot-system" class="nav-link">Integration into a IoT system</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#object-detection-with-detectnet" class="nav-link">Object detection with detectNet</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#mqtt" class="nav-link">MQTT</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="integration-into-a-iot-system">Integration into a IoT system</h1>
<h2 id="object-detection-with-detectnet">Object detection with detectNet</h2>
<p>We're are working in <strong>object detection</strong>, and finding where in the frame various objects are located by extracting their bounding boxes.  Unlike image classification, object detection networks are capable of detecting many different objects per frame.</p>
<p><img src="https://github.com/dusty-nv/jetson-inference/raw/dev/docs/images/detectnet.jpg" ></p>
<p>The <a href="https://github.com/dusty-nv/jetson-inference/blob/master/c/detectNet.h"><code>detectNet</code></a> object accepts an image as input, and outputs a list of coordinates of the detected bounding boxes along with their classes and confidence values.  </p>
<h3 id="source-listing">Source Listing</h3>
<p>That's it!  For completness, here's the full source of the Python script that we just created:</p>
<pre><code class="language-python">import jetson.inference
import jetson.utils

net = jetson.inference.detectNet(&quot;ssd-mobilenet-v2&quot;, threshold=0.5)
camera = jetson.utils.videoSource(&quot;csi://0&quot;)      # '/dev/video0' for V4L2
display = jetson.utils.videoOutput(&quot;display://0&quot;) # 'my_video.mp4' for file

while display.IsStreaming():
    img = camera.Capture()
    detections = net.Detect(img)
    display.Render(img)
    display.SetStatus(&quot;Object Detection | Network {:.0f} FPS&quot;.format(net.GetNetworkFPS()))
</code></pre>
<p>Note that this version assumes you are using a MIPI CSI camera.</p>
<h3 id="running-the-program">Running the Program</h3>
<p>To run the application we just coded, simply launch it from a terminal with the Python interpreter:</p>
<pre><code class="language-bash">$ python3 my-detection.py
</code></pre>
<h2 id="mqtt">MQTT</h2>
<p><a href="https://en.wikipedia.org/wiki/MQTT">MQTT</a> comes from MQ Telemetry Transport
    * Publish-subscribe based messaging protocol
    * Implemented over TCP/IP
    * Designed for remote connections with low bandwidth requirements
    * Initially developed by IBM</p>
<h3 id="history">History</h3>
<p>Andy Stanford-Clark (IBM) and Arlen Nipper (then working for Eurotech, Inc.) authored the first version of the protocol in 1999. It was used to monitor oil pipelines within the SCADA industrial control system. The goal was to have a protocol that is bandwidth-efficient, lightweight and uses little battery power, because the devices were connected via satellite link which, at that time, was extremely expensive.</p>
<p><img src="../figures/500px-Pipeline-Scada.jpg" ></p>
<h3 id="how-mqtt-works">How MQTT works</h3>
<ul>
<li>Simile ~ Postal Mail System<ul>
<li>Message sent by <em>sender</em> (<strong>publisher</strong>) through the centralized system: Post Office (<strong>broker</strong>)</li>
<li>Postal Mail sends it to the <em>address</em> (<strong>subscriber</strong>)</li>
<li>The <strong>publisher</strong> and <strong>subscriber</strong> are autonomous (unlike the HTTP Client-Server system)</li>
<li>The theme or <strong>topic</strong> is a point the <strong>publishers</strong> connect to. Acts as the distribution center<ul>
<li>The <strong>topics</strong> are simple and hierarchical</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="../figures/mqtt-diagram.png" ></p>
<h3 id="mqtt-topics">MQTT Topics</h3>
<p>In MQTT, the word topic refers to an UTF-8 string that the broker uses to filter messages for each connected client. The topic consists of one or more topic levels. Each topic level is separated by a forward slash (topic level separator).</p>
<p><img src="../figures/topic_basics.png" ></p>
<h3 id="mqtt-message">MQTT Message</h3>
<p>Message consists of 3 parts:
    * Fixed header: 2 bytes and it is mandatory to send in all messages.
    * Variable header: 4 bits and is not required in messages.
    * Message or payload (<strong>payload</strong>). Maximum of 256 Mbits although in real implementations, the maximum 2-4 kB.</p>
<h3 id="mosquitto">Mosquitto</h3>
<p><a href="https://mosquitto.org/">Mosquitto</a> is an open source (EPL/EDL licensed) message broker that implements the MQTT protocol.</p>
<p>There is a package previously build in the Jetson-Nano to test the Mosquitto implementation and the check how MQTT protocol is working. Follow the next steps to find out how MQTT works:</p>
<ul>
<li><strong>1</strong> Install Mosquitto Clients on the Jetson-Nano</li>
</ul>
<pre><code class="language-bash">nano@jetson-nano:~$ sudo apt-get install mosquitto-clients
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  libc-ares2 libmosquitto1
The following NEW packages will be installed:
  libc-ares2 libmosquitto1 mosquitto-clients
0 upgraded, 3 newly installed, 0 to remove and 31 not upgraded.
Need to get 91,9 kB of archives.
After this operation, 337 kB of additional disk space will be used.
Do you want to continue? [Y/n] Y

</code></pre>
<ul>
<li><strong>2</strong> Init subscriptor with <code>mosquitto_sub -h BROKER -t TOPIC</code> where <em>BROKER</em> corresponds to broker address and <em>TOPIC</em> the topic to be subscrited</li>
</ul>
<pre><code class="language-bash">nano@jetson-nano:~$ mosquitto_sub -h BROKER -t TOPIC

</code></pre>
<ul>
<li><strong>3</strong> Now you are ready to publish a message in the broker with <code>mosquitto_pub -h BROKER -t TOPIC -m MSG</code>, where <em>BROKER</em> corresponds to broker IP address, <em>TOPIC</em> the topic to be subscrited, and <em>MSG</em> the message or <strong>payload</strong> to be sent to the broker</li>
</ul>
<h3 id="mqtt-client-in-python">MQTT client in Python</h3>
<p>There is an API to use the MQTT protocol in python, to be integrated with the previous development performed as <strong>object detection application</strong>. Please note, that some <a href="https://pypi.org/project/paho-mqtt/">Paho MQTT client library</a> should be installed in your Jetson-Nano board:</p>
<pre><code class="language-bash">root@jetson-nano:/jetson-inference# pip3 install paho-mqtt
Collecting paho-mqtt
  Downloading https://files.pythonhosted.org/packages/f8/dd/4b75dcba025f8647bc9862ac17299e0d7d12d3beadbf026d8c8d74215c12/paho-mqtt-1.6.1.tar.gz (99kB)
    100% |################################| 102kB 1.6MB/s 
Building wheels for collected packages: paho-mqtt
  Running setup.py bdist_wheel for paho-mqtt ... done
  Stored in directory: /root/.cache/pip/wheels/b7/18/24/b9f50d4ff75478d9ccb373bcaa454fc1573cdd39fbad37f49e
Successfully built paho-mqtt
Installing collected packages: paho-mqtt
Successfully installed paho-mqtt-1.6.1

</code></pre>
<h4 id="publish-a-message">Publish a message</h4>
<p>This code provides a client class which enable applications to connect to an MQTT broker to publish messages. It also provides some helper functions to make publishing one off messages to an MQTT server very straightforward.</p>
<p>You can use the client class as an instance, within a class or by subclassing. </p>
<h5 id="example">Example</h5>
<ul>
<li>The general usage flow is as follows:<ul>
<li>Create a client instance with <code>mqtt.Client</code></li>
<li>Connect to a broker using one of the <code>connect*()</code> functions. Note that the <strong>Broker address</strong> corresponds to <em>broker_address variable</em></li>
<li>Call one of the <code>loop*()</code> functions to maintain network traffic flow with the broker</li>
<li>Use <code>publish()</code> to publish messages to the broker. Note that the <strong>TOPIC</strong> is refer as <em>"house/bulbs/bulb1"</em> and the <strong>payload</strong> as <em>"ON"</em></li>
</ul>
</li>
</ul>
<pre><code class="language-python">import paho.mqtt.client as mqtt
import time

############
def on_message(client, userdata, message):
    print(&quot;message received &quot; ,str(message.payload.decode(&quot;utf-8&quot;)))
    print(&quot;message topic=&quot;,message.topic)
    print(&quot;message qos=&quot;,message.qos)
    print(&quot;message retain flag=&quot;,message.retain)

########################################
broker_address=&quot;test.mosquitto.org&quot;
print(&quot;creating new instance&quot;)
client = mqtt.Client(&quot;P1&quot;) #create new instance
client.on_message=on_message #attach function to callback
print(&quot;connecting to broker&quot;)
client.connect(broker_address) #connect to broker
client.loop_start() #start the loop
print(&quot;Publishing message to topic&quot;,&quot;house/bulbs/bulb1&quot;)
client.publish(&quot;house/bulbs/bulb1&quot;,&quot;ON&quot;)
time.sleep(4) # wait
client.loop_stop() #stop the loop
</code></pre>
<div class="admonition danger">
<p class="admonition-title">Assignment: system that counts people crossing the entry or exit like in the photo and send information through MQTT</p>
<p>Modify the code <strong>my-detection.py</strong> developed adding the functionality of sending the number of people that are entering to an area every 10 seconds. Note that your application should publish in the topic <em>"shopping/cameraID/people_count/"</em>. Each node should implement the people counter and publish in the corresponding topic, that is, group 1 would have the topic "shopping/camera1/people_count/" assigned.</p>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../../js/base.js" defer></script>
        <script src="../../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
